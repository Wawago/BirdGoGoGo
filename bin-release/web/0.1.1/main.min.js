var __reflect=this&&this.__reflect||function(t,e,i){t.__class__=e,i?i.push(e):i=[e],t.__types__=t.__types__?i.concat(t.__types__):i},__extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])};return function(e,i){function o(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(o.prototype=i.prototype,new o)}}(),Main=function(t){function e(){var e=t.call(this)||this;return e.isResourceLoaded=!1,e.isThemeLoaded=!1,e.addEventListener(egret.Event.ADDED_TO_STAGE,e.onAddToStage,e),e}return __extends(e,t),e.prototype.onAddToStage=function(t){egret.lifecycle.addLifecycleListener(function(t){}),egret.lifecycle.onPause=function(){egret.ticker.pause()},egret.lifecycle.onResume=function(){egret.ticker.resume()},this.stage.registerImplementation("eui.IAssetAdapter",new AssetAdapter),this.stage.registerImplementation("eui.IThemeAdapter",new ThemeAdapter),this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},e.prototype.onConfigComplete=function(t){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this);var e=new eui.Theme("resource/default.thm.json",this.stage);e.addEventListener(eui.UIEvent.COMPLETE,this.onThemeLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),RES.loadGroup("preload")},e.prototype.onThemeLoadComplete=function(){this.isThemeLoaded=!0,this.createGameScene()},e.prototype.onResourceLoadComplete=function(t){"preload"==t.groupName&&(this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),this.isResourceLoaded=!0,this.createGameScene())},e.prototype.onItemLoadError=function(t){console.warn("Url:"+t.resItem.url+" has failed to load")},e.prototype.onResourceLoadError=function(t){console.warn("Group:"+t.groupName+" has failed to load"),this.onResourceLoadComplete(t)},e.prototype.onResourceProgress=function(t){"preload"==t.groupName&&this.loadingView.setProgress(t.itemsLoaded,t.itemsTotal)},e.prototype.createGameScene=function(){this.isThemeLoaded&&this.isResourceLoaded&&(GameData.stageW=this.stage.stageWidth,GameData.stageH=this.stage.stageHeight,this.gameView=new GameView,this.gameView.x=GameData.stageW/2,this.gameView.y=GameData.stageH/2,this.addChild(this.gameView))},e}(egret.DisplayObjectContainer);__reflect(Main.prototype,"Main");var AssetAdapter=function(){function t(){}return t.prototype.getAsset=function(t,e,i){function o(o){e.call(i,o,t)}if(RES.hasRes(t)){var s=RES.getRes(t);s?o(s):RES.getResAsync(t,o,this)}else RES.getResByUrl(t,o,this,RES.ResourceItem.TYPE_IMAGE)},t}();__reflect(AssetAdapter.prototype,"AssetAdapter",["eui.IAssetAdapter"]);var GameData=function(){function t(){}return t.stageW=0,t.stageH=0,t.closeMusic=!1,t.closeBgMusic=!1,t.isStart=!1,t.curScene=1,t.isPause=!0,t.bgSpeed=0,t.score=0,t}();__reflect(GameData.prototype,"GameData");var GameView=function(t){function e(){var e=t.call(this)||this;return e.birdBodyRadius=38,e.gravity=25,e.birdJumpSpeed=-13,e.isStart=!1,e.initView(),e.initSprites(),e.initContactMaterials(),e.initEvents(),e.initGUI(),e}return __extends(e,t),e.prototype.initView=function(){this.anchorOffsetX=GameData.stageW/2,this.anchorOffsetY=GameData.stageH/2,this.width=GameData.stageW,this.height=GameData.stageH;var t=Utils.createBitmapByName("background_png");t.width=GameData.stageW,t.height=GameData.stageH,this.addChild(t),this.world=new p2.World({gravity:[0,0]}),this.world.sleepMode=p2.World.BODY_SLEEPING,this.touchEnabled=!0},e.prototype.initSprites=function(){this.createBird(),this.createPipeGroups(),this.groundBody=PipeGroup.createBlock(this.world,this,0,GameData.stageH-PipeGroup.groundHeight,2*GameData.stageW,PipeGroup.groundHeight,0,"ground_png")},e.prototype.initContactMaterials=function(){var t=new p2.Material(0),e=new p2.Material(1);this.birdBody.shapes[0].material=t,this.groundBody.shapes[0].material=e,this.pipeGroup1.upperPipe.shapes[0].material=e,this.pipeGroup1.lowerPipe.shapes[0].material=e,this.pipeGroup2.upperPipe.shapes[0].material=e,this.pipeGroup2.lowerPipe.shapes[0].material=e,this.pipeGroup3.upperPipe.shapes[0].material=e,this.pipeGroup3.lowerPipe.shapes[0].material=e;var i=new p2.ContactMaterial(t,e,{friction:100,stiffness:1e4,relaxation:1,frictionRelaxation:10});this.world.addContactMaterial(i)},e.prototype.initGUI=function(){this.startButton=new eui.Button,this.startButton.label="Go!",this.startButton.horizontalCenter=0,this.startButton.verticalCenter=0,this.startButton.x=GameData.stageW/2-50,this.startButton.y=GameData.stageH/2-25,this.addChild(this.startButton),this.startButton.addEventListener(egret.TouchEvent.TOUCH_TAP,this.gameStart,this),this.scoreLabel=new eui.Label,this.updateScoreLabel(),this.addChild(this.scoreLabel)},e.prototype.createPipeGroups=function(){this.pipeGroup1=new PipeGroup(this.world,this),this.pipeGroup2=new PipeGroup(this.world,this),this.pipeGroup3=new PipeGroup(this.world,this)},e.prototype.createBird=function(){this.bird=new Bird,this.bird.x=GameData.stageW/3,this.bird.y=GameData.stageH/2,this.addChild(this.bird),this.birdBody=new p2.Body({mass:5,type:p2.Body.DYNAMIC,position:P2Space.getP2Pos(this.bird.x,this.bird.y),allowSleep:!1}),this.birdBody.angularDamping=.98;var t=new p2.Circle({radius:P2Space.extentP2(this.birdBodyRadius)});this.birdBody.addShape(t),this.world.addBody(this.birdBody),this.birdBody.displays=[this.bird]},e.prototype.initEvents=function(){this.addEventListener(egret.Event.ENTER_FRAME,this.onEnterFrame,this),this.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onTouchScreen,this)},e.prototype.onTouchScreen=function(){this.isStart&&this.bird.isAlive&&(this.birdBody.velocity[1]=this.birdJumpSpeed,this.bird.jump())},e.prototype.onEnterFrame=function(){this.world.step(.06);var t=P2Space.getEgretLoc(this.groundBody);t[0]<=0&&(this.groundBody.position[0]=P2Space.extentP2(GameData.stageW)),this.pipeGroup1.updatePipePostions(),this.pipeGroup2.updatePipePostions(),this.pipeGroup3.updatePipePostions(),P2Space.syncDisplayForGroup(this.world.bodies),this.checkGetPoint(),this.checkCollision()},e.prototype.checkCollision=function(){this.bird.isAlive&&(this.birdBody.overlaps(this.groundBody)||this.pipeGroup1.collides(this.birdBody)||this.pipeGroup2.collides(this.birdBody)||this.pipeGroup3.collides(this.birdBody))&&this.gameOver()},e.prototype.checkGetPoint=function(){(this.pipeGroup1.checkGetPoint(this.birdBody)||this.pipeGroup2.checkGetPoint(this.birdBody)||this.pipeGroup3.checkGetPoint(this.birdBody))&&(GameData.score++,this.updateScoreLabel())},e.prototype.updateScoreLabel=function(){this.scoreLabel.text="SCORE: "+GameData.score},e.prototype.gameStart=function(){this.startButton.visible=!1,this.isStart=!0,GameData.score=0,this.updateScoreLabel(),this.birdBody.position=P2Space.getP2Pos(GameData.stageW/3,GameData.stageH/2),this.birdBody.velocity=[0,0],this.birdBody.angle=0,this.birdBody.angularVelocity=0,this.bird.fly(),this.pipeGroup1.moveToX(GameData.stageW+PipeGroup.pipeWidth/2),this.pipeGroup2.moveToX(GameData.stageW+PipeGroup.pipeWidth/2+PipeGroup.pipeGapX),this.pipeGroup3.moveToX(GameData.stageW+PipeGroup.pipeWidth/2+2*PipeGroup.pipeGapX),this.groundBody.velocity[0]=e.speedX,this.pipeGroup1.start(),this.pipeGroup2.start(),this.pipeGroup3.start(),this.world.gravity[1]=this.gravity},e.prototype.gameOver=function(){this.isStart=!1,this.groundBody.velocity[0]=0,this.pipeGroup1.stop(),this.pipeGroup2.stop(),this.pipeGroup3.stop(),this.bird.die(),ShakeUtils.getInstance().shakeObj(this,.5,10,8),egret.setTimeout(this.showRestartButton,this,500)},e.prototype.showRestartButton=function(){this.startButton.label="Restart",this.startButton.visible=!0},e.speedX=-2.5,e}(egret.Sprite);__reflect(GameView.prototype,"GameView");var LoadingUI=function(t){function e(){var e=t.call(this)||this;return e.createView(),e}return __extends(e,t),e.prototype.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},e.prototype.setProgress=function(t,e){this.textField.text="Loading..."+t+"/"+e},e}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI");var Bird=function(t){function e(){var e=t.call(this)||this;return e.sfxDie=RES.getRes("sfx_die_mp3"),e.sfxHit=RES.getRes("sfx_hit_mp3"),e.sfxPoint=RES.getRes("sfx_point_mp3"),e.sfxJump=RES.getRes("sfx_jump_mp3"),e.isAlive=!0,e.initView(),e}return __extends(e,t),e.prototype.initView=function(){var t=RES.getRes("bird_json"),e=RES.getRes("bird_png"),i=new egret.MovieClipDataFactory(t,e);this.mc=new egret.MovieClip(i.generateMovieClipData("bird")),this.addChild(this.mc),this.anchorOffsetX=.5*this.mc.width,this.anchorOffsetY=.5*this.mc.height,this.fly()},e.prototype.fly=function(){this.isAlive=!0,this.mc.gotoAndPlay("fly",-1)},e.prototype.jump=function(){this.sfxJump.play(0,1)},e.prototype.die=function(){this.isAlive=!1,this.mc.gotoAndPlay("die",1),this.sfxHit.play(0,1)},e.prototype.point=function(){this.sfxPoint.play(0,1)},e.prototype.dispose=function(){this.removeChildren()},e}(egret.Sprite);__reflect(Bird.prototype,"Bird");var P2Space=function(){function t(){}return t.syncDisplay=function(e,i){if(void 0===i&&(i=""),e){var o=e.displays[0];if(o){var s=t.getEgretLoc(e,i);o.x=s[0],o.y=s[1],o.rotation=360-180*e.angle/Math.PI,i.length&&console.log(i+"的锚点",o.anchorOffsetX,o.anchorOffsetY)}}},t.syncDisplayForGroup=function(t){for(var e=0,i=t;e<i.length;e++){var o=i[e];this.syncDisplay(o)}},t.extentEgret=function(t){return t*this.$factor},t.extentP2=function(t){return t/this.$factor},t.getP2Pos=function(t,e){return[t/this.$factor,e/this.$factor]},t.getEgretLoc=function(t,e){void 0===e&&(e="");var i=t.position[0],o=t.position[1];return e.length&&console.log("["+e+"]getEgretLoc:",i,o,"(p2->egret)",i*this.$factor,o*this.$factor),[i*this.$factor,o*this.$factor]},t.$factor=50,t}();__reflect(P2Space.prototype,"P2Space");var PipeGroup=function(){function t(e,i){this.haveGotPoint=!1,this.sfxPoint=RES.getRes("sfx_point_mp3"),this.pipeRebornX=3*t.pipeGapX-t.pipeWidth/2,this.totalPipeLength=GameData.stageH-t.groundHeight-t.pipeGapY,this.createPipes(e,i)}return t.prototype.createPipes=function(e,i){var o=this.getRandomPipeHeight();this.upperPipe=t.createBlock(e,i,GameData.stageW,o-t.pipeHeight,t.pipeWidth,t.pipeHeight,0,"upper_pipe_png"),this.lowerPipe=t.createBlock(e,i,GameData.stageW,o+t.pipeGapY,t.pipeWidth,t.pipeHeight,0,"lower_pipe_png"),this.coin=this.createCoin(e,i,GameData.stageW,o+t.pipeGapY/2-42.5)},t.prototype.createCoin=function(t,e,i,o){var s=new p2.Body({mass:1,fixedRotation:!0,position:P2Space.getP2Pos(i+42,o+42.5),collisionResponse:!1,type:p2.Body.KINEMATIC});t.addBody(s);var r=new p2.Circle({radius:P2Space.extentP2(84)});s.addShape(r);var a=Utils.createBitmapByName("coin_png");return a.anchorOffsetX=.5*a.width,a.anchorOffsetY=.5*a.height,s.displays=[a],e.addChild(a),s},t.createBlock=function(t,e,i,o,s,r,a,n){var p=new p2.Body({mass:1,fixedRotation:!0,position:P2Space.getP2Pos(i+s/2,o+r/2),type:p2.Body.KINEMATIC,velocity:[a,0]});t.addBody(p);var h=new p2.Box({width:P2Space.extentP2(s),height:P2Space.extentP2(r)});p.addShape(h);var c=Utils.createBitmapByName(n);return c.width=s,c.height=r,c.anchorOffsetX=.5*c.width,c.anchorOffsetY=.5*c.height,p.displays=[c],e.addChild(c),p},t.prototype.updatePipePostions=function(){if(P2Space.extentEgret(this.upperPipe.position[0])<=-t.pipeWidth/2){var e=this.getRandomPipeHeight();this.moveToX(this.pipeRebornX),this.upperPipe.position[1]=P2Space.extentP2(e-.5*t.pipeHeight),this.lowerPipe.position[1]=P2Space.extentP2(e+t.pipeGapY+.5*t.pipeHeight),this.coin.position[1]=P2Space.extentP2(e+t.pipeGapY/2)}},t.prototype.moveToX=function(t){this.upperPipe.position[0]=P2Space.extentP2(t),this.lowerPipe.position[0]=P2Space.extentP2(t),this.coin.position[0]=P2Space.extentP2(t),this.coin.displays[0].visible=!0,this.haveGotPoint=!1},t.prototype.getRandomPipeHeight=function(){return Math.floor((this.totalPipeLength-2*t.minPipeHeight)*Math.random()+t.minPipeHeight)},t.prototype.stop=function(){this.upperPipe.velocity[0]=0,this.lowerPipe.velocity[0]=0,this.coin.velocity[0]=0},t.prototype.start=function(){this.upperPipe.velocity[0]=GameView.speedX,this.lowerPipe.velocity[0]=GameView.speedX,this.coin.velocity[0]=GameView.speedX},t.prototype.collides=function(t){return t.overlaps(this.upperPipe)||t.overlaps(this.lowerPipe)},t.prototype.checkGetPoint=function(t){return this.coin.overlaps(t)&&!this.haveGotPoint?(this.haveGotPoint=!0,this.sfxPoint.play(0,1),this.coin.displays[0].visible=!1,!0):!1},t.groundHeight=210,t.pipeHeight=753,t.pipeWidth=142,t.pipeGapX=400,t.pipeGapY=280,t.minPipeHeight=130,t}();__reflect(PipeGroup.prototype,"PipeGroup");var ShakeUtils=function(){function t(){this.count=0,this.timer=new egret.Timer(1e3)}return t.getInstance=function(){return null==this.instance&&(this.instance=new t),this.instance},t.prototype.shakeObj=function(t,e,i,o){this.target=t,this.initX=t.x,this.initY=t.y,this.maxDis=o,this.count=e*i,this.rate=i,this.timer.delay=1e3/i,this.timer.repeatCount=this.count,this.timer.addEventListener(egret.TimerEvent.TIMER,this.shaking,this),this.timer.addEventListener(egret.TimerEvent.TIMER_COMPLETE,this.shakeComplete,this),this.timer.reset(),this.timer.start()},t.prototype.shaking=function(){egret.Tween.removeTweens(this.target),this.target.x=this.initX-this.maxDis+Math.random()*this.maxDis*2,this.target.y=this.initY-this.maxDis+Math.random()*this.maxDis*2,egret.Tween.get(this.target).to({x:this.initX,y:this.initY},999/this.rate)},t.prototype.shakeComplete=function(){this.target&&(egret.Tween.removeTweens(this.target),this.target.x=this.initX,this.target.y=this.initY),this.timer.removeEventListener(egret.TimerEvent.TIMER,this.shaking,this),this.timer.removeEventListener(egret.TimerEvent.TIMER_COMPLETE,this.shakeComplete,this)},t.prototype.stop=function(){this.shakeComplete()},t}();__reflect(ShakeUtils.prototype,"ShakeUtils");var ThemeAdapter=function(){function t(){}return t.prototype.getTheme=function(t,e,i,o){function s(t){e.call(o,t)}function r(e){e.resItem.url==t&&(RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,r,null),i.call(o))}RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,r,null),RES.getResByUrl(t,s,this,RES.ResourceItem.TYPE_TEXT)},t}();__reflect(ThemeAdapter.prototype,"ThemeAdapter",["eui.IThemeAdapter"]);var Utils=function(){function t(){}return t.createBitmapByName=function(t){var e=new egret.Bitmap,i=RES.getRes(t);return e.texture=i,e},t}();__reflect(Utils.prototype,"Utils");